import{S as T}from"./dag.module.6dc78b46.js";import{G as v}from"./index.6abc819d.js";import{a as y,X as w,N as S,E as C,b as O,c as x,P as M,d as b,e as R,f as I,g as P,h as H}from"./dag-config.e2eb20b1.js";import{l as G,_ as o}from"./lodash.68b7405b.js";import{a as z}from"./index.73124cc7.js";import F from"./dag-context-menu.e22e9ab5.js";import{a as E,e as k,d as K,A as _,c as L}from"./index.851b5188.js";import"./task-type.dfd9250b.js";import"./gForce.3509cc7a.js";import"./service.4be3af67.js";import"./dag-node-status.8cc86097.js";import"./toNumber.c7e8ca68.js";import"./_baseMap.9542141b.js";import"./get.aa32335f.js";import"./debounce.948fb11c.js";import"./index.18b4303b.js";import"./common.ee372ad3.js";import"./SettingOutlined.e20148d7.js";import"./PauseCircleOutlined.28d888d0.js";import"./CloseCircleOutlined.9e282d8c.js";import"./CheckCircleOutlined.67794958.js";import"./EditOutlined.e0b6da4a.js";import"./index.d671386a.js";import"./Button.4e249408.js";import"./is-browser.45c3bd93.js";import"./use-form-item.bb4d7ada.js";import"./resolve-slot.9e6a0162.js";import"./typeof.b54b2da3.js";import"./ui-setting.39219f0f.js";import"./Icon.afc45566.js";import"./format-length.d7d829b3.js";import"./Spin.447cad15.js";import"./fade-in.cssr.55dfcced.js";import"./use-compitable.ae5454ac.js";import"./index.7a579f81.js";import"./Tooltip.52cb9ce9.js";import"./Popover.30015336.js";import"./index.e739cd60.js";import"./flatten.05a2e46f.js";import"./Scrollbar.7a99b971.js";import"./VResizeObserver.6721b9ea.js";import"./use-false-until-truthy.5d7093c9.js";import"./utils.f449ed5c.js";import"./use-merged-state.e40d3a9f.js";import"./next-frame-once.e5ee25e8.js";function V(N){const{readonly:n,graph:r}=N,p=E(),g=E(),u=E();function m(){return v.registerNodeTool("contextmenu",F,!0),new v({container:p.value,selecting:{enabled:!0,multiple:!0,rubberband:!0,rubberEdge:!0,movable:!0,showNodeSelectionBox:!1},scaling:{min:.2,max:2},mousewheel:{enabled:!0,modifiers:["ctrl","meta"]},scroller:!0,grid:{size:10,visible:!0},snapline:!0,minimap:{enabled:!0,container:g.value,scalable:!0,width:250,height:150},interacting:{edgeLabelMovable:!1,nodeMovable:!n.value,magnetConnectable:!n.value},connecting:{allowMulti:!1,allowBlank:!1,allowLoop:!1,allowEdge:!1,allowNode:!0,allowPort:!1,highlight:!0,createEdge(){var t;return(t=r.value)==null?void 0:t.createEdge({shape:y})},validateConnection(t){var i;const{sourceCell:a,targetCell:s}=t;if(a&&s&&a.isNode()&&s.isNode()){const c=a.getData();if(!c||c.taskType!=="CONDITIONS")return!0;const D=(i=r.value)==null?void 0:i.getConnectedEdges(a);if(!D||D.length<2)return!0;let d=0;return!D.some(f=>(f.getSourceCellId()===a.id&&d++,d>2))}return!0},validateEdge({edge:t}){var i,c;const a=(i=t.getSourceNode())==null?void 0:i.getData(),s=(c=t.getTargetNode())==null?void 0:c.getData();return t==null||t.setAttrs({line:{strokeDasharray:a.taskExecuteType==="STREAM"||s.taskExecuteType==="STREAM"?"5 5":"none"}}),!0}},highlighting:{nodeAvailable:{name:"className",args:{className:"available"}},magnetAvailable:{name:"className",args:{className:"available"}},magnetAdsorbed:{name:"className",args:{className:"adsorbed"}}}})}k(()=>{r.value=m(),r.value.on("edge:connected",({isNew:t,edge:a})=>{if(t){const s=a.getSourceNode();a.setSource(s)}}),r.value.on("node:mouseenter",({node:t})=>{const a=t.getData().taskName,i=t.getMarkup().filter(c=>c.tagName==="foreignObject")[0];t.addTools({name:"button",args:{markup:[{tagName:"text",textContent:a,attrs:{fill:"#868686","font-size":16,"text-anchor":"center"}}],x:0,y:0,offset:{x:0,y:i?-28:-10}}})}),r.value.on("node:mouseleave",({node:t})=>{t.removeTool("button")})});const e=G.exports.debounce(()=>{var t;if(u.value){const a=u.value.offsetWidth,s=u.value.offsetHeight;(t=r.value)==null||t.resize(a,s)}},200);z(u,e);function l(){v.unregisterNode(w),v.unregisterEdge(y),v.registerNode(w,{...S}),v.registerEdge(y,{...C})}return k(()=>{l()}),{graph:r,paper:p,minimap:g,container:u}}function X(N){const{graph:n}=N,r=E(),p=e=>e?e.toLocaleLowerCase()==="em"||e.toLocaleLowerCase()==="body":!1;function g(e){var s;const l=e===r.value,t=(s=n.value)==null?void 0:s.isSelected(e);let a=null;l?a=o.merge(o.cloneDeep(C),O):t?a=o.merge(o.cloneDeep(C),x):a=o.cloneDeep(C),e.setAttrs(a.attrs),e.setLabels([{...o.merge({attrs:o.cloneDeep(a.defaultLabel.attrs)})}])}function u(e){var A;const l=e===r.value,t=(A=n.value)==null?void 0:A.isSelected(e),a=o.cloneDeep(M.groups[b].attrs),s=o.cloneDeep(R.groups[b].attrs),i=o.cloneDeep(I.groups[b].attrs),c=o.merge(o.cloneDeep(S.attrs),P.attrs),D=o.merge(o.cloneDeep(S.attrs),H.attrs);let d=null,f=null,h=null;l||t?(d=`/dolphinscheduler/ui/images/task-icons/${(e.data.taskType!=="FLINK_STREAM"?e.data.taskType:"FLINK").toLocaleLowerCase()}_hover.png`,l?(f=c,h=o.merge(i,a)):(f=D,h=o.merge(i,s))):(d=`/dolphinscheduler/ui/images/task-icons/${(e.data.taskType!=="FLINK_STREAM"?e.data.taskType:"FLINK").toLocaleLowerCase()}.png`,f=S.attrs,h=i),e.setAttrByPath("image/xlink:href",d),e.setAttrs(f),e.setPortProp(b,"attrs",h)}function m(e){e.isEdge()?g(e):e.isNode()&&u(e)}return k(()=>{n.value&&(n.value.on("cell:mouseenter",e=>{const{cell:l,e:t}=e;p(t.target.tagName)||(r.value=l,m(l))}),n.value.on("cell:mouseleave",({cell:e})=>{r.value=void 0,m(e)}),n.value.on("cell:selected",({cell:e})=>{m(e)}),n.value.on("cell:unselected",({cell:e})=>{m(e)}))}),{hoverCell:r}}const Ie=K({name:"workflow-dag-canvas",emits:["drop"],setup(N,n){const r=_("readonly",E(!1)),p=_("graph",E()),{paper:g,minimap:u,container:m}=V({readonly:r,graph:p});X({graph:p});const e=l=>{l.preventDefault()};return()=>L("div",{ref:m,class:[T.canvas,"dag-container"],onDrop:l=>{n.emit("drop",l)},onDragenter:e,onDragover:e,onDragleave:e},[L("div",{ref:g,class:T.paper},null),L("div",{ref:u,class:T.minimap},null)])}});export{Ie as default};
