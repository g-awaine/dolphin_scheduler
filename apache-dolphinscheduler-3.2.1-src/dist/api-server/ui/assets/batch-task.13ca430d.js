import{u as M,bI as q,bt as H,aL as A,a as l,t as r,d as B,at as F,e as G,w as x,ba as K,c as n}from"./index.851b5188.js";import{u as U}from"./index.73124cc7.js";import{d as X,f as Y,q as J,L as Q,a as Z}from"./index.d95f3dc5.js";import{B as $}from"./index.8acb741a.js";import{r as w,p as _,t as ee,s as te}from"./common.ee372ad3.js";import{D as ae,C as c,c as oe}from"./column-width-config.4c11a147.js";import{C as se}from"./CheckCircleOutlined.67794958.js";import{A as re}from"./AlignLeftOutlined.db1eb979.js";import{D as ie}from"./DownloadOutlined.2b4ed5b8.js";import{f as D}from"./index.d671386a.js";import{N as ne}from"./Ellipsis.b13f7726.js";import{N as b}from"./Tooltip.52cb9ce9.js";import{N as L}from"./Button.4e249408.js";import{N}from"./Icon.afc45566.js";import{N as k}from"./Space.f9ece73f.js";import{N as le}from"./Spin.447cad15.js";import{u as ce}from"./ui-setting.39219f0f.js";import{C as v}from"./index.6c124806.js";import{S as pe}from"./SearchOutlined.3b9a5586.js";import{N as T}from"./Input.79ba0d48.js";import{a as me}from"./Select.3e0f2c28.js";import{N as ue}from"./DatePicker.b69ef36a.js";import{N as de,a as he}from"./DataTable.0e9ec324.js";import"./service.4be3af67.js";import"./lodash.68b7405b.js";import"./index.e69e8738.js";import"./keysOf.ab13e590.js";import"./Card.19bc42e2.js";import"./resolve-slot.9e6a0162.js";import"./index.7a579f81.js";import"./index.e739cd60.js";import"./flatten.05a2e46f.js";import"./Scrollbar.7a99b971.js";import"./fade-in.cssr.55dfcced.js";import"./VResizeObserver.6721b9ea.js";import"./use-false-until-truthy.5d7093c9.js";import"./fade-in-scale-up.cssr.5737b1c6.js";import"./utils.f449ed5c.js";import"./is-browser.45c3bd93.js";import"./index.3ef69258.js";import"./SyncOutlined.95d4ed16.js";import"./FullscreenOutlined.01f40161.js";import"./use-locale.f8ac8f2c.js";import"./throttle.821ebb8d.js";import"./debounce.948fb11c.js";import"./toNumber.c7e8ca68.js";import"./SettingOutlined.e20148d7.js";import"./PauseCircleOutlined.28d888d0.js";import"./CloseCircleOutlined.9e282d8c.js";import"./EditOutlined.e0b6da4a.js";import"./Popover.30015336.js";import"./_baseMap.9542141b.js";import"./get.aa32335f.js";import"./format-length.d7d829b3.js";import"./use-merged-state.e40d3a9f.js";import"./use-compitable.ae5454ac.js";import"./next-frame-once.e5ee25e8.js";import"./use-form-item.bb4d7ada.js";import"./get-slot.80096ab3.js";import"./Suffix.21a8a87f.js";import"./Selection.28a32045.js";import"./typeof.b54b2da3.js";import"./use-keyboard.f4d2f0c0.js";import"./Forward.bddcd6d4.js";import"./ArrowDown.45f9e719.js";import"./Checkbox.98b84c16.js";import"./RadioGroup.c3ead4f3.js";import"./Radio.fc32ca3b.js";import"./Dropdown.4af83811.js";import"./ChevronRight.d6536995.js";function ge(){const{t}=M(),m=q(),p=H(),e=Number(m.params.projectCode),h=Number(m.params.processInstanceId),g=m.params.taskName,o=A({columns:[],tableWidth:ae,tableData:[],page:l(1),pageSize:l(10),searchVal:l(g||null),processInstanceId:l(h||null),host:l(null),stateType:l(null),datePickerRange:l(null),executorName:l(null),processInstanceName:l(null),totalPage:l(1),showModalRef:l(!1),row:{},loadingRef:l(!1),logRef:"",logLoadingRef:l(!0),skipLineNum:l(0),limit:l(1e3)}),i=s=>{s.columns=[{title:"#",key:"index",render:(a,d)=>d+1,...c.index},{title:t("project.task.task_name"),key:"name",...c.name,resizable:!0,minWidth:200,maxWidth:600},{title:t("project.task.workflow_instance"),key:"processInstanceName",...c.linkName,resizable:!0,minWidth:300,maxWidth:600,render:a=>r($,{onClick:()=>{const d=p.resolve({name:"workflow-instance-detail",params:{id:a.processInstanceId},query:{code:e}});window.open(d.href,"_blank")}},{default:()=>r(ne,{style:"max-width: 580px;line-height: 1.5"},()=>a.processInstanceName)})},{title:t("project.task.executor"),key:"executorName",...c.name},{title:t("project.task.node_type"),key:"taskType",...c.type},{title:t("project.task.state"),key:"state",...c.state,render:a=>fe(a.state,t)},{title:t("project.task.submit_time"),...c.time,key:"submitTime",render:a=>w(a.submitTime)},{title:t("project.task.start_time"),...c.time,key:"startTime",render:a=>w(a.startTime)},{title:t("project.task.end_time"),...c.time,key:"endTime",render:a=>w(a.endTime)},{title:t("project.task.duration"),key:"duration",...c.duration,render:a=>r("span",null,a.duration?a.duration:"-")},{title:t("project.task.retry_count"),key:"retryTimes",...c.times},{title:t("project.task.dry_run_flag"),key:"dryRun",...c.dryRun,render:a=>a.dryRun===1?"YES":"NO"},{title:t("project.task.host"),key:"host",...c.name,render:a=>a.host||"-"},{title:t("project.task.app_link"),key:"appLink",...c.name,render:a=>a.appLink||"-"},{title:t("project.task.operation"),key:"operation",...c.operation(3),render(a){return r(k,null,{default:()=>[r(b,{},{trigger:()=>r(L,{tag:"div",circle:!0,type:"info",size:"small",disabled:!(a.state==="FAILURE"||a.state==="NEED_FAULT_TOLERANCE"||a.state==="KILL"),onClick:()=>{j(a)}},{icon:()=>r(N,null,{default:()=>r(se)})}),default:()=>t("project.task.forced_success")}),r(b,{},{trigger:()=>r(L,{circle:!0,type:"info",size:"small",disabled:!a.host,onClick:()=>u(a)},{icon:()=>r(N,null,{default:()=>r(re)})}),default:()=>t("project.task.view_log")}),r(b,{},{trigger:()=>r(L,{circle:!0,type:"info",size:"small",disabled:!a.host,onClick:()=>X(a.id)},{icon:()=>r(N,null,{default:()=>r(ie)})}),default:()=>t("project.task.download_log")})]})}}],s.tableWidth&&(s.tableWidth=oe(s.columns))},u=s=>{o.showModalRef=!0,o.row=s},j=s=>{Y({id:s.id},{projectCode:e}).then(()=>{y({pageSize:o.pageSize,pageNo:o.tableData.length===1&&o.page>1?o.page-1:o.page,searchVal:o.searchVal,processInstanceId:o.processInstanceId,host:o.host,stateType:o.stateType,datePickerRange:o.datePickerRange,executorName:o.executorName,processInstanceName:o.processInstanceName})})},y=s=>{if(o.loadingRef)return;o.loadingRef=!0;const a={pageSize:s.pageSize,pageNo:s.pageNo,searchVal:s.searchVal,processInstanceId:s.processInstanceId,host:s.host,stateType:s.stateType,startDate:s.datePickerRange?D(_(s.datePickerRange[0]),"yyyy-MM-dd HH:mm:ss"):"",endDate:s.datePickerRange?D(_(s.datePickerRange[1]),"yyyy-MM-dd HH:mm:ss"):"",executorName:s.executorName,processInstanceName:s.processInstanceName},{state:d}=U(J(a,{projectCode:e}).then(I=>{o.tableData=I.totalList,o.totalPage=I.totalPage,o.loadingRef=!1}),{});return d};return{t,variables:o,getTableData:y,createColumns:i}}function fe(t,m){if(!t)return"";const p=ee(m)[t],e=r(N,{color:p.color,class:p.classNames,style:{display:"flex"},size:20},()=>r(p.icon));return r(b,null,{trigger:()=>p.isSpin?r(le,{size:20},{icon:()=>e}):e,default:()=>p.desc})}const Dt=B({name:"task-instance",setup(){var P;const m=ce().getLogTimer,{t:p,variables:e,getTableData:h,createColumns:g}=ge(),o=()=>{h({pageSize:e.pageSize,pageNo:e.page,searchVal:e.searchVal,processInstanceId:e.processInstanceId,host:e.host,stateType:e.stateType,datePickerRange:e.datePickerRange,executorName:e.executorName,processInstanceName:e.processInstanceName})},i=()=>{e.page=1,o()},u=()=>{e.page=1,o()},j=()=>{e.searchVal="",u()},y=()=>{e.processInstanceName=null,u()},s=()=>{e.executorName=null,u()},a=()=>{e.host=null,u()},d=()=>{e.stateType=null,u()},I=()=>{e.datePickerRange=null,u()},V=()=>{e.showModalRef=!1};let z;const R=(f,S)=>{const{state:O}=U(Z({taskInstanceId:Number(f.id),limit:e.limit,skipLineNum:e.skipLineNum}).then(C=>{e.logRef+=C.message||"",C&&C.message!==""?(e.limit+=1e3,e.skipLineNum+=C.lineNum,R(f,S)):(e.logLoadingRef=!1,S!==0&&(typeof z=="number"&&clearTimeout(z),z=setTimeout(()=>{e.logRef="",e.limit=1e3,e.skipLineNum=0,e.logLoadingRef=!0,R(f,S)},S*1e3)))}),{});return O},W=f=>{e.logRef="",e.limit=1e3,e.skipLineNum=0,R(f,m)},E=(P=F())==null?void 0:P.appContext.config.globalProperties.trim;return G(()=>{g(e),o()}),x(M().locale,()=>{g(e)}),x(()=>e.showModalRef,()=>{e.showModalRef?R(e.row,m):(e.row={},e.logRef="",e.logLoadingRef=!0,e.skipLineNum=0,e.limit=1e3)}),{t:p,...K(e),requestTableData:o,onUpdatePageSize:i,onSearch:u,onClearSearchTaskName:j,onClearSearchProcessInstanceName:y,onClearSearchExecutorName:s,onClearSearchHost:a,onClearSearchStateType:d,onClearSearchTime:I,onConfirmModal:V,refreshLogs:W,trim:E}},render(){const{t,requestTableData:m,onUpdatePageSize:p,onSearch:e,onConfirmModal:h,loadingRef:g,refreshLogs:o}=this;return n(k,{vertical:!0},{default:()=>[n(v,null,{default:()=>[n(k,{justify:"end",wrap:!1},{default:()=>[n(T,{allowInput:this.trim,value:this.searchVal,"onUpdate:value":i=>this.searchVal=i,size:"small",placeholder:t("project.task.task_name"),clearable:!0,onClear:this.onClearSearchTaskName},null),n(T,{allowInput:this.trim,value:this.processInstanceName,"onUpdate:value":i=>this.processInstanceName=i,size:"small",placeholder:t("project.task.workflow_instance"),clearable:!0,onClear:this.onClearSearchProcessInstanceName},null),n(T,{allowInput:this.trim,value:this.executorName,"onUpdate:value":i=>this.executorName=i,size:"small",placeholder:t("project.task.executor"),clearable:!0,onClear:this.onClearSearchExecutorName},null),n(T,{allowInput:this.trim,value:this.host,"onUpdate:value":i=>this.host=i,size:"small",placeholder:t("project.task.host"),clearable:!0,onClear:this.onClearSearchHost},null),n(me,{value:this.stateType,"onUpdate:value":i=>this.stateType=i,size:"small",options:te(t).slice(1),placeholder:t("project.task.state"),style:{width:"180px"},clearable:!0,onClear:this.onClearSearchStateType},null),n(ue,{value:this.datePickerRange,"onUpdate:value":i=>this.datePickerRange=i,type:"datetimerange",size:"small","start-placeholder":t("project.task.start_time"),"end-placeholder":t("project.task.end_time"),clearable:!0,onClear:this.onClearSearchTime},null),n(L,{size:"small",type:"primary",onClick:e},{default:()=>[n(N,null,{default:()=>[n(pe,null,null)]})]})]})]}),n(v,{title:t("project.task.batch_task")},{default:()=>[n(k,{vertical:!0},{default:()=>[n(de,{loading:g,columns:this.columns,data:this.tableData,scrollX:this.tableWidth},null),n(k,{justify:"center"},{default:()=>[n(he,{page:this.page,"onUpdate:page":i=>this.page=i,"page-size":this.pageSize,"onUpdate:page-size":i=>this.pageSize=i,"page-count":this.totalPage,"show-size-picker":!0,"page-sizes":[10,30,50],"show-quick-jumper":!0,onUpdatePage:m,onUpdatePageSize:p},null)]})]})]}),n(Q,{showModalRef:this.showModalRef,logRef:this.logRef,row:this.row,logLoadingRef:this.logLoadingRef,onConfirmModal:h,onRefreshLogs:o},null)]})}});export{Dt as default};
