import{l as D}from"./lodash.68b7405b.js";import{u as b,aL as L,a as I,d as E,at as M,w as P,e as S,ba as w,c as d}from"./index.851b5188.js";import{s as C}from"./service.4be3af67.js";import{v as V,u as B,c as j}from"./index.9bc4b0ad.js";import{M as A}from"./index.e69e8738.js";import{F as J,g as T}from"./get-elements-by-json.9201707b.js";import{N as x}from"./Input.79ba0d48.js";import{a as k}from"./Select.3e0f2c28.js";import"./ui-setting.39219f0f.js";import"./index.8acb741a.js";import"./Button.4e249408.js";import"./is-browser.45c3bd93.js";import"./use-form-item.bb4d7ada.js";import"./resolve-slot.9e6a0162.js";import"./keysOf.ab13e590.js";import"./Card.19bc42e2.js";import"./index.7a579f81.js";import"./index.e739cd60.js";import"./flatten.05a2e46f.js";import"./Scrollbar.7a99b971.js";import"./fade-in.cssr.55dfcced.js";import"./VResizeObserver.6721b9ea.js";import"./use-false-until-truthy.5d7093c9.js";import"./fade-in-scale-up.cssr.5737b1c6.js";import"./utils.f449ed5c.js";import"./index.3ef69258.js";import"./Space.f9ece73f.js";import"./get-slot.80096ab3.js";import"./Form.9f7fa8c1.js";import"./FormItem.f5b3f80b.js";import"./format-length.d7d829b3.js";import"./get.aa32335f.js";import"./Grid.3ae564e0.js";import"./next-frame-once.e5ee25e8.js";import"./Spin.447cad15.js";import"./use-compitable.ae5454ac.js";import"./Radio.fc32ca3b.js";import"./RadioGroup.c3ead4f3.js";import"./use-merged-state.e40d3a9f.js";import"./index.2fc51a01.js";import"./DeleteOutlined.07e1d3fe.js";import"./Switch.f95d65b1.js";import"./InputNumber.cc83334e.js";import"./use-locale.f8ac8f2c.js";import"./Add.3164a73d.js";import"./Checkbox.98b84c16.js";import"./TreeSelect.5a0f3466.js";import"./Selection.28a32045.js";import"./Popover.30015336.js";import"./_baseMap.9542141b.js";import"./Suffix.21a8a87f.js";function W(n){return C({url:"/ui-plugins/query-by-type",method:"get",params:n})}function $(n){return C({url:`/ui-plugins/${n}`,method:"get"})}function z(){const{t:n}=b(),s={instanceName:"",pluginDefineId:null},e=L({detailFormRef:I(),detailForm:{...s},uiPlugins:[],pluginsLoading:!1,json:[]}),r={model:e.detailForm,requireMarkPlacement:"left",labelPlacement:"left",labelWidth:180,rules:{instanceName:{trigger:"input",required:!0,message:n("security.alarm_instance.alarm_instance_name_tips")},pluginDefineId:{trigger:["blur","change"],required:!0,validator(i,l){if(!l&&l!==0)return new Error(n("security.alarm_instance.select_plugin_tips"))}}}},a=async()=>{if(!e.pluginsLoading){e.pluginsLoading=!0;try{const i=await W({pluginType:"ALERT"});e.uiPlugins=i.map(l=>({label:l.pluginName,value:l.id})),e.pluginsLoading=!1}catch{e.pluginsLoading=!1}}};return{meta:r,state:e,setDetail:i=>{e.detailForm.instanceName=i.instanceName,e.detailForm.pluginDefineId=i.pluginDefineId,i.pluginInstanceParams&&(e.json=JSON.parse(i.pluginInstanceParams))},initForm:()=>{a()},resetForm:()=>{e.detailFormRef.resetValues({...s}),e.json=[]},getFormValues:()=>e.detailForm,changePlugin:async i=>{if(e.pluginsLoading)return;e.pluginsLoading=!0,e.detailForm.pluginDefineId=i;const{pluginParams:l}=await $(i);l&&(e.json=JSON.parse(l)),e.pluginsLoading=!1}}}function G(n){const s=L({saving:!1,loading:!1}),e=(a,o={})=>(a==null||a.forEach(t=>{const u=D.exports.isFunction(t)?t():t;u.value=o[u.field]}),JSON.stringify(a));return{status:s,createOrUpdate:async(a,o)=>{const t=n();if(s.saving)return!1;s.saving=!0;try{return(a==null?void 0:a.instanceName)!==t.instanceName&&await V({alertInstanceName:t.instanceName}),a!=null&&a.id?await B({alertPluginInstanceId:t.pluginDefineId,instanceName:t.instanceName,pluginInstanceParams:e(o,t)},a.id):await j({instanceName:t.instanceName,pluginDefineId:t.pluginDefineId,pluginInstanceParams:e(o,t)}),s.saving=!1,!0}catch{return s.saving=!1,!1}}}}const H={show:{type:Boolean,default:!1},currentRecord:{type:Object,default:{}}},ze=E({name:"DetailModal",props:H,emits:["cancel","update"],setup(n,s){var F;const{t:e}=b(),r=I({}),a=I([]),{meta:o,state:t,setDetail:u,initForm:g,resetForm:p,getFormValues:i,changePlugin:l}=z(),{status:f,createOrUpdate:y}=G(i),m=()=>{p(),r.value={},a.value=[],s.emit("cancel")},c=async()=>{await t.detailFormRef.validate(),await y(n.currentRecord,t.json)&&(m(),s.emit("update"))},U=l,O=(F=M())==null?void 0:F.appContext.config.globalProperties.trim;return P(()=>n.show,async()=>{n.show&&n.currentRecord&&u(n.currentRecord)}),P(()=>t.json,()=>{var N;if(!((N=t.json)!=null&&N.length))return;t.json.forEach(h=>{const v=D.exports.isFunction(h)?h():h;v.name=e("security.alarm_instance."+v.field)});const{rules:_,elements:q}=T(t.json,t.detailForm);r.value=_,a.value=q}),S(()=>{g()}),{t:e,...w(t),...w(f),meta:o,rules:r,elements:a,onChangePlugin:U,onSubmit:c,onCancel:m,trim:O}},render(n){const{show:s,t:e,meta:r,rules:a,elements:o,detailForm:t,uiPlugins:u,pluginsLoading:g,loading:p,saving:i,onChangePlugin:l,onCancel:f,onSubmit:y}=this,{currentRecord:m}=n;return d(A,{show:s,title:e(m!=null&&m.id?"security.alarm_instance.edit_alarm_instance":"security.alarm_instance.create_alarm_instance"),onConfirm:y,confirmLoading:i||p,onCancel:f},{default:()=>d(J,{ref:"detailFormRef",loading:p||g,meta:{...r,rules:{...r.rules,...a},elements:[{path:"instanceName",label:e("security.alarm_instance.alarm_instance_name"),widget:d(x,{allowInput:this.trim,value:t.instanceName,"onUpdate:value":c=>t.instanceName=c,placeholder:e("security.alarm_instance.alarm_instance_name_tips")},null)},{path:"pluginDefineId",label:e("security.alarm_instance.select_plugin"),widget:d(k,{value:t.pluginDefineId,"onUpdate:value":c=>t.pluginDefineId=c,options:u,disabled:!!(m!=null&&m.id),placeholder:e("security.alarm_instance.select_plugin_tips"),"on-update:value":l},null)},...o]},layout:{cols:24}},null)})}});export{ze as default};
